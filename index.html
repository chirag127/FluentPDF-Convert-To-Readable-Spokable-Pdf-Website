<!DOCTYPE html>
<html lang="en" class="antialiased">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SpeakFlow - Cached AI PDF Converter</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: '#6366f1', // Indigo 500
                        secondary: '#10b981', // Emerald 500
                        dark: '#0f172a', // Slate 950
                        surface: '#1e293b' // Slate 800
                    },
                    fontFamily: { sans: ['Inter', 'system-ui', 'sans-serif'], mono: ['Fira Code', 'monospace'] },
                    animation: { 'pulse-fast': 'pulse 1s cubic-bezier(0.4, 0, 0.6, 1) infinite' }
                }
            }
        }
    </script>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';</script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/idb@7/build/umd.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <style>
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #94a3b8; border-radius: 3px; }
        .glass-panel { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(12px); border: 1px solid rgba(226, 232, 240, 0.8); }
        .dark .glass-panel { background: rgba(15, 23, 42, 0.95); border: 1px solid rgba(51, 65, 85, 0.8); }
        select { -webkit-appearance: none; background-image: url("data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3E%3Cpath stroke='%2364748b' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3E%3C/svg%3E"); background-position: right 0.75rem center; background-repeat: no-repeat; background-size: 1.25em 1.25em; }
    </style>
</head>
<body class="bg-slate-50 text-slate-900 dark:bg-slate-950 dark:text-slate-100 transition-colors duration-300 min-h-screen flex flex-col font-sans">

    <nav class="glass-panel sticky top-0 z-50 shadow-sm border-b border-slate-200 dark:border-slate-800">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16 items-center">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 bg-gradient-to-br from-primary to-purple-600 rounded-xl flex items-center justify-center text-white shadow-lg shadow-primary/20">
                        <i class="fa-solid fa-layer-group"></i>
                    </div>
                    <div>
                        <span class="font-bold text-lg tracking-tight block leading-none">SpeakFlow</span>
                        <span class="text-[10px] font-mono text-slate-500 dark:text-slate-400 uppercase tracking-wide">Smart Cache Engine</span>
                    </div>
                </div>
                <div class="flex items-center gap-3">
                    <button id="themeToggle" class="p-2 rounded-lg hover:bg-slate-100 dark:hover:bg-slate-800 transition-colors"><i class="fa-solid fa-moon dark:hidden"></i><i class="fa-solid fa-sun hidden dark:block text-yellow-400"></i></button>
                    <button onclick="app.ui.openSettings()" class="p-2 rounded-lg hover:bg-slate-100 dark:hover:bg-slate-800 relative group">
                        <i class="fa-solid fa-gear group-hover:rotate-90 transition-transform duration-500"></i>
                        <span id="settingsBadge" class="absolute top-1.5 right-1.5 w-2 h-2 bg-red-500 rounded-full hidden animate-pulse"></span>
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <main class="flex-grow max-w-7xl mx-auto px-4 py-8 w-full grid grid-cols-1 lg:grid-cols-12 gap-8">

        <div class="lg:col-span-8 space-y-6">

            <div id="dropZone" class="glass-panel rounded-3xl p-12 border-2 border-dashed border-slate-300 dark:border-slate-700 hover:border-primary dark:hover:border-primary transition-all cursor-pointer group text-center relative overflow-hidden">
                <input type="file" id="fileInput" accept=".pdf" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-10">
                <div class="relative z-20 transition-transform group-hover:scale-[1.02] duration-300">
                    <div class="w-16 h-16 bg-slate-100 dark:bg-slate-800 rounded-2xl flex items-center justify-center mx-auto mb-4 text-primary group-hover:bg-primary group-hover:text-white transition-colors">
                        <i class="fa-solid fa-database text-2xl"></i>
                    </div>
                    <h3 class="text-xl font-bold mb-2">Upload PDF</h3>
                    <p class="text-sm text-slate-500">Checks local database for instant loading.</p>
                </div>
            </div>

            <div id="fileInfoPanel" class="hidden glass-panel rounded-2xl p-6 border-l-4 border-primary flex flex-col sm:flex-row items-center justify-between gap-4 animate-fade-in">
                <div class="flex items-center gap-4 w-full">
                    <div class="w-12 h-12 bg-blue-50 dark:bg-blue-900/20 text-blue-600 rounded-xl flex items-center justify-center text-xl"><i class="fa-regular fa-file-pdf"></i></div>
                    <div class="flex-1 min-w-0">
                        <h4 id="fileName" class="font-bold truncate max-w-[200px]">doc.pdf</h4>
                        <p id="fileSize" class="text-xs text-slate-500 font-mono">0 MB</p>
                    </div>
                </div>
                <div class="flex gap-2 w-full sm:w-auto">
                    <button onclick="app.core.clearFile()" class="p-3 text-slate-400 hover:text-red-500 transition-colors"><i class="fa-solid fa-times"></i></button>
                    <button onclick="app.core.startProcessing()" id="processBtn" class="flex-1 bg-primary hover:bg-indigo-600 text-white font-semibold py-3 px-6 rounded-xl shadow-lg transition-all flex items-center gap-2 whitespace-nowrap">
                        <i class="fa-solid fa-bolt"></i> Process
                    </button>
                </div>
            </div>

            <div id="progressPanel" class="hidden glass-panel rounded-3xl p-8 space-y-6">
                <div class="flex justify-between items-end">
                    <div>
                        <h3 class="font-bold text-lg">Processing Document</h3>
                        <p id="strategyStatus" class="text-xs text-slate-500 font-mono uppercase mt-1">Initializing...</p>
                    </div>
                    <span id="totalProgressText" class="text-4xl font-black text-transparent bg-clip-text bg-gradient-to-r from-primary to-purple-500">0%</span>
                </div>
                <div class="bg-slate-50 dark:bg-slate-800 rounded-xl p-4 border border-slate-200 dark:border-slate-700">
                    <div id="batchContainer" class="grid grid-cols-12 gap-1.5 max-h-[150px] overflow-y-auto custom-scrollbar"></div>
                </div>
                <button onclick="location.reload()" class="text-red-500 text-xs font-bold hover:underline">STOP</button>
            </div>

            <div id="resultPanel" class="hidden glass-panel rounded-3xl p-10 text-center border-t-4 border-secondary">
                <div class="w-20 h-20 bg-emerald-100 dark:bg-emerald-900/30 text-emerald-600 rounded-full flex items-center justify-center mx-auto mb-4 text-3xl">
                    <i class="fa-solid fa-check"></i>
                </div>
                <h2 class="text-2xl font-bold mb-2">Conversion Complete</h2>
                <p class="text-slate-600 dark:text-slate-400 mb-8 text-sm">Saved to local database for future access.</p>
                <div class="flex justify-center gap-4">
                    <button onclick="app.core.downloadFinal()" class="bg-secondary hover:bg-emerald-600 text-white font-bold py-3 px-8 rounded-xl shadow-lg flex items-center gap-2">
                        <i class="fa-solid fa-download"></i> Download PDF
                    </button>
                    <button onclick="location.reload()" class="bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 py-3 px-6 rounded-xl font-semibold hover:bg-slate-50">New File</button>
                </div>
            </div>
        </div>

        <div class="lg:col-span-4 space-y-6">
            <div class="glass-panel rounded-2xl overflow-hidden flex flex-col h-[500px] shadow-sm">
                <div class="p-4 border-b border-slate-200 dark:border-slate-700 bg-slate-50 dark:bg-slate-800 flex justify-between items-center">
                    <span class="text-xs font-bold uppercase text-slate-500">Engine Logs</span>
                    <span id="activeProvider" class="text-[10px] font-mono bg-slate-200 dark:bg-slate-700 px-2 py-1 rounded">IDLE</span>
                </div>
                <div id="logConsole" class="flex-1 overflow-y-auto bg-slate-950 p-4 font-mono text-[10px] space-y-2">
                    <div class="text-slate-500 italic">System ready...</div>
                </div>
            </div>
        </div>
    </main>

    <div id="cacheModal" class="fixed inset-0 z-[100] hidden">
        <div class="absolute inset-0 bg-slate-900/60 backdrop-blur-sm"></div>
        <div class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 w-full max-w-md bg-white dark:bg-slate-900 rounded-2xl shadow-2xl p-6 border border-slate-200 dark:border-slate-700">
            <div class="text-center mb-6">
                <div class="w-16 h-16 bg-blue-100 dark:bg-blue-900/30 text-blue-600 rounded-full flex items-center justify-center mx-auto mb-4 text-2xl">
                    <i class="fa-solid fa-history"></i>
                </div>
                <h3 class="text-xl font-bold text-slate-900 dark:text-white">File Found in Cache</h3>
                <p class="text-sm text-slate-500 dark:text-slate-400 mt-2">You have processed this file before. Would you like to load the saved version or reprocess it?</p>
                <p id="cacheDate" class="text-xs font-mono text-slate-400 mt-1"></p>
            </div>
            <div class="flex gap-3">
                <button onclick="app.core.processCache(false)" class="flex-1 bg-slate-100 dark:bg-slate-800 hover:bg-slate-200 text-slate-700 dark:text-slate-200 py-3 rounded-xl font-semibold text-sm transition-colors">
                    Reprocess (Use API)
                </button>
                <button onclick="app.core.processCache(true)" class="flex-1 bg-primary hover:bg-indigo-600 text-white py-3 rounded-xl font-bold text-sm shadow-lg transition-colors">
                    Load Cached PDF
                </button>
            </div>
        </div>
    </div>

    <div id="settingsModal" class="fixed inset-0 z-[100] hidden">
        <div class="absolute inset-0 bg-slate-900/50 backdrop-blur-sm" onclick="app.ui.closeSettings()"></div>
        <div id="settingsPanel" class="absolute inset-y-0 right-0 max-w-md w-full bg-white dark:bg-slate-900 shadow-2xl transform translate-x-full transition-transform duration-300 flex flex-col">
            <div class="p-6 border-b border-slate-200 dark:border-slate-800 flex justify-between items-center">
                <h2 class="text-lg font-bold">Configuration</h2>
                <button onclick="app.ui.closeSettings()"><i class="fa-solid fa-times"></i></button>
            </div>
            <div class="flex-1 overflow-y-auto p-6 space-y-6">

                <div class="space-y-4">
                    <label class="block text-sm font-bold"><i class="fa-brands fa-google mr-2"></i>Gemini API</label>
                    <input type="password" id="key_gemini" class="w-full bg-slate-50 dark:bg-slate-800 border border-slate-300 dark:border-slate-700 rounded-lg px-4 py-2 text-sm">

                    <label class="block text-xs font-medium text-slate-500">Primary Model</label>
                    <select id="pref_gemini_model" class="w-full bg-slate-50 dark:bg-slate-800 border border-slate-300 dark:border-slate-700 rounded-lg px-4 py-2 text-sm">
                        <option value="gemini-2.5-flash-lite-preview-09-2025">Gemini 2.5 Flash Lite</option>
                        <option value="gemini-2.5-flash-preview-09-2025">Gemini 2.5 Flash</option>
                        <option value="gemini-2.5-pro">Gemini 2.5 Pro</option>
                        <option value="gemini-3-pro-preview">Gemini 3 Pro</option>
                    </select>
                </div>

                <div class="space-y-4">
                    <label class="block text-sm font-bold"><i class="fa-solid fa-bolt mr-2 text-orange-500"></i>Groq API</label>
                    <input type="password" id="key_groq" class="w-full bg-slate-50 dark:bg-slate-800 border border-slate-300 dark:border-slate-700 rounded-lg px-4 py-2 text-sm">
                    <p class="text-[10px] text-slate-400">Includes Llama 3.3 70B, Mixtral 8x7b</p>
                </div>

                <div class="space-y-4">
                    <label class="block text-sm font-bold"><i class="fa-solid fa-brain mr-2 text-pink-500"></i>Cerebras API</label>
                    <input type="password" id="key_cerebras" class="w-full bg-slate-50 dark:bg-slate-800 border border-slate-300 dark:border-slate-700 rounded-lg px-4 py-2 text-sm">
                    <p class="text-[10px] text-slate-400">Includes Llama 3.1 70B</p>
                </div>

                <hr class="border-slate-200 dark:border-slate-800">

                <div class="grid grid-cols-2 gap-4">
                    <div><label class="text-xs font-bold">Batch Size</label><input type="number" id="set_batchSize" value="15000" class="w-full bg-slate-50 dark:bg-slate-800 border border-slate-300 rounded p-2 text-sm"></div>
                    <div><label class="text-xs font-bold">Retry Delay</label><input type="number" id="set_retryDelay" value="2000" class="w-full bg-slate-50 dark:bg-slate-800 border border-slate-300 rounded p-2 text-sm"></div>
                </div>
            </div>
            <div class="p-4 border-t border-slate-200 dark:border-slate-800">
                <button onclick="app.ui.saveSettings()" class="w-full bg-primary text-white font-bold py-3 rounded-xl shadow-lg">Save</button>
            </div>
        </div>
    </div>

    <script>
        const app = {
            state: { file: null, chunks: [], results: [], finalPDF: null },
            config: { get: k => localStorage.getItem(`sf_${k}`), set: (k, v) => localStorage.setItem(`sf_${k}`, v) },

            // === FULL MODEL LIST (Requested) ===
            models: {
                gemini: ["gemini-2.5-flash-lite-preview-09-2025", "gemini-2.5-flash-preview-09-2025", "gemini-2.5-pro", "gemini-3-pro-preview"],
                groq: [
                    "llama-3.3-70b-versatile", "mixtral-8x7b-32768", "llama-3.1-70b-versatile",
                    "llama-3.2-90b-text-preview", "gemma2-9b-it", "llama-3.1-8b-instant"
                ],
                cerebras: [
                    "llama-3.3-70b", "llama3.1-70b", "llama-3.1-8b"
                ]
            },

            providers: {
                gemini: {
                    url: (m, k) => `https://generativelanguage.googleapis.com/v1beta/models/${m}:generateContent?key=${k}`,
                    headers: () => ({'Content-Type': 'application/json'}),
                    payload: (sys, user) => ({ contents: [{ parts: [{ text: `${sys}\n\n---\n\n${user}` }] }] }),
                    extract: (d) => d.candidates?.[0]?.content?.parts?.[0]?.text
                },
                groq: {
                    url: () => `https://api.groq.com/openai/v1/chat/completions`,
                    headers: (k) => ({'Content-Type': 'application/json', 'Authorization': `Bearer ${k}`}),
                    payload: (sys, user, m) => ({ model: m, messages: [{ role: "system", content: sys }, { role: "user", content: user }] }),
                    extract: (d) => d.choices?.[0]?.message?.content
                },
                cerebras: {
                    url: () => `https://api.cerebras.ai/v1/chat/completions`,
                    headers: (k) => ({'Content-Type': 'application/json', 'Authorization': `Bearer ${k}`}),
                    payload: (sys, user, m) => ({ model: m, messages: [{ role: "system", content: sys }, { role: "user", content: user }] }),
                    extract: (d) => d.choices?.[0]?.message?.content
                }
            },

            // === INDEXED DB CACHE ===
            db: {
                init: async () => {
                    return await idb.openDB('speakflow_v1', 1, {
                        upgrade(db) {
                            if (!db.objectStoreNames.contains('records')) {
                                db.createObjectStore('records', { keyPath: 'id' });
                            }
                        },
                    });
                },
                saveRecord: async (file, pdfBlob) => {
                    const db = await app.db.init();
                    const id = `${file.name}_${file.size}`;
                    await db.put('records', {
                        id: id,
                        fileName: file.name,
                        date: new Date(),
                        originalFile: file,
                        outputBlob: pdfBlob
                    });
                    app.ui.log('Saved to Cache', 'success');
                },
                checkRecord: async (file) => {
                    const db = await app.db.init();
                    const id = `${file.name}_${file.size}`;
                    return await db.get('records', id);
                }
            },

            ui: {
                init: () => {
                    if (localStorage.getItem('theme') === 'dark' || (!localStorage.getItem('theme') && window.matchMedia('(prefers-color-scheme: dark)').matches)) document.documentElement.classList.add('dark');
                    document.getElementById('themeToggle').addEventListener('click', () => document.documentElement.classList.toggle('dark'));

                    const drop = document.getElementById('dropZone');
                    drop.addEventListener('click', () => document.getElementById('fileInput').click());
                    document.getElementById('fileInput').addEventListener('change', (e) => app.core.handleFile(e.target.files[0]));
                    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(n => drop.addEventListener(n, (e) => {e.preventDefault(); e.stopPropagation()}));
                    drop.addEventListener('drop', (e) => app.core.handleFile(e.dataTransfer.files[0]));

                    app.ui.checkKeys();
                },
                checkKeys: () => {
                    const hasKey = ['key_gemini','key_groq','key_cerebras'].some(k => app.config.get(k));
                    document.getElementById('settingsBadge').classList.toggle('hidden', !!hasKey);
                },
                openSettings: () => {
                    document.getElementById('settingsModal').classList.remove('hidden');
                    setTimeout(() => document.getElementById('settingsPanel').classList.remove('translate-x-full'), 10);
                    ['key_gemini','key_groq','key_cerebras'].forEach(k => document.getElementById(k).value = app.config.get(k) || '');
                    if(app.config.get('pref_gemini_model')) document.getElementById('pref_gemini_model').value = app.config.get('pref_gemini_model');
                },
                closeSettings: () => {
                    document.getElementById('settingsPanel').classList.add('translate-x-full');
                    setTimeout(() => document.getElementById('settingsModal').classList.add('hidden'), 300);
                },
                saveSettings: () => {
                    ['key_gemini','key_groq','key_cerebras'].forEach(k => app.config.set(k, document.getElementById(k).value.trim()));
                    app.config.set('set_batchSize', document.getElementById('set_batchSize').value);
                    app.config.set('set_retryDelay', document.getElementById('set_retryDelay').value);
                    app.config.set('pref_gemini_model', document.getElementById('pref_gemini_model').value);
                    app.ui.closeSettings();
                    app.ui.checkKeys();
                },
                log: (msg, type) => {
                    const el = document.getElementById('logConsole');
                    const div = document.createElement('div');
                    div.className = type === 'success' ? 'text-green-400' : type === 'error' ? 'text-red-400' : 'text-slate-400';
                    div.textContent = `[${new Date().toLocaleTimeString()}] ${msg}`;
                    el.appendChild(div);
                    el.scrollTop = el.scrollHeight;
                },
                updateBatch: (i, status) => {
                    const el = document.getElementById(`batch-${i}`);
                    if (el) el.className = `h-2 w-full rounded-full transition-all ${status==='processing'?'bg-yellow-400 animate-pulse':status==='success'?'bg-green-500':status==='error'?'bg-red-500':'bg-slate-200'}`;
                }
            },

            core: {
                handleFile: async (f) => {
                    if (!f || f.type !== 'application/pdf') return alert('PDF Only');
                    app.state.file = f;

                    // Check Cache First
                    const cached = await app.db.checkRecord(f);
                    if(cached) {
                        document.getElementById('cacheDate').textContent = `Saved: ${cached.date.toLocaleString()}`;
                        document.getElementById('cacheModal').classList.remove('hidden');
                        app.state.cachedRecord = cached;
                        return;
                    }

                    app.core.loadUI(f);
                },
                processCache: (useCache) => {
                    document.getElementById('cacheModal').classList.add('hidden');
                    if(useCache) {
                        // Load Blob directly
                        app.state.finalPDFBlob = app.state.cachedRecord.outputBlob;
                        document.getElementById('dropZone').classList.add('hidden');
                        document.getElementById('resultPanel').classList.remove('hidden');
                        app.ui.log('Loaded from Cache', 'success');
                    } else {
                        // Reprocess
                        app.core.loadUI(app.state.file);
                    }
                },
                loadUI: (f) => {
                    document.getElementById('dropZone').classList.add('hidden');
                    document.getElementById('fileInfoPanel').classList.remove('hidden');
                    document.getElementById('fileName').textContent = f.name;
                    document.getElementById('fileSize').textContent = (f.size/1024/1024).toFixed(2) + " MB";
                },
                clearFile: () => location.reload(),
                startProcessing: async () => {
                    if (!['key_gemini','key_groq','key_cerebras'].some(k => app.config.get(k))) return app.ui.openSettings();

                    document.getElementById('fileInfoPanel').classList.add('hidden');
                    document.getElementById('progressPanel').classList.remove('hidden');

                    app.ui.log('Extracting Text...');
                    const text = await app.core.extractText(app.state.file);
                    const batchSize = parseInt(app.config.get('set_batchSize') || 15000);
                    app.state.chunks = app.core.chunk(text, batchSize);

                    const container = document.getElementById('batchContainer');
                    container.innerHTML = '';
                    app.state.chunks.forEach((_, i) => {
                        const d = document.createElement('div');
                        d.id = `batch-${i}`; d.className = 'h-2 w-full bg-slate-200 dark:bg-slate-700 rounded-full';
                        container.appendChild(d);
                    });

                    app.state.results = new Array(app.state.chunks.length);

                    for (let i = 0; i < app.state.chunks.length; i++) {
                        await app.engine.process(app.state.chunks[i], i);
                        document.getElementById('totalProgressText').textContent = Math.round(((i+1)/app.state.chunks.length)*100) + '%';
                    }

                    await app.core.finish();
                },
                extractText: async (f) => {
                    const pdf = await pdfjsLib.getDocument(await f.arrayBuffer()).promise;
                    let txt = "";
                    for(let i=1; i<=pdf.numPages; i++) txt += (await (await pdf.getPage(i)).getTextContent()).items.map(x=>x.str).join(' ') + "\n\n";
                    return txt;
                },
                chunk: (t, s) => {
                    const chunks = []; let cur = "";
                    t.split('\n').forEach(l => { if(cur.length + l.length > s) { chunks.push(cur); cur = l + "\n"; } else cur += l + "\n"; });
                    if(cur) chunks.push(cur);
                    return chunks;
                },
                renderMarkdownToPdf: (doc, markdownText) => {
                    const tokens = marked.lexer(markdownText);
                    let y = 20, pageHeight = 280, margin = 20, maxWidth = 170;

                    const addText = (text, fontSize, fontStyle) => {
                        doc.setFontSize(fontSize);
                        doc.setFont("times", fontStyle);
                        const cleanText = text.replace(/\*\*/g, '').replace(/\*/g, '').replace(/#/g, '').replace(/`/g, '');
                        const lines = doc.splitTextToSize(cleanText, maxWidth);
                        lines.forEach(line => {
                            if (y > pageHeight) { doc.addPage(); y = margin; }
                            doc.text(line, margin, y);
                            y += (fontSize * 0.4);
                        });
                        y += (fontSize * 0.2);
                    };

                    tokens.forEach(token => {
                        if (token.type === 'heading') { addText(token.text, 16, 'bold'); y += 2; }
                        else if (token.type === 'paragraph') { addText(token.text, 12, 'normal'); }
                        else if (token.type === 'list') { token.items.forEach(item => addText("â€¢ " + item.text, 12, 'normal')); }
                        else if (token.type === 'code') { addText(token.text, 11, 'italic'); }
                    });
                },
                finish: async () => {
                    const doc = new window.jspdf.jsPDF();
                    app.state.results.forEach(res => { if(res) app.core.renderMarkdownToPdf(doc, res); });

                    // Generate Blob
                    const pdfBlob = doc.output('blob');
                    app.state.finalPDFBlob = pdfBlob;

                    // Save to DB
                    await app.db.saveRecord(app.state.file, pdfBlob);

                    document.getElementById('progressPanel').classList.add('hidden');
                    document.getElementById('resultPanel').classList.remove('hidden');
                },
                downloadFinal: () => {
                    if(app.state.finalPDFBlob) {
                        const url = URL.createObjectURL(app.state.finalPDFBlob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = `spokable_${app.state.file.name}`;
                        document.body.appendChild(a);
                        a.click();
                        document.body.removeChild(a);
                    }
                }
            },

            engine: {
                process: async (text, idx) => {
                    app.ui.updateBatch(idx, 'processing');
                    const sysPrompt = `You are a specialized Accessibility Engine. Convert technical PDF text into "Spokable Script" for TTS.
                    INSTRUCTIONS: 1. OUTPUT Markdown. 2. PRESERVE English narrative EXACTLY. 3. Describe Code logic (no syntax). 4. Summarize Tables. 5. Expand Math. 6. Remove headers/footers.`;

                    let attempts = [];
                    if(app.config.get('key_gemini')) {
                        const k = app.config.get('key_gemini');
                        const pref = app.config.get('pref_gemini_model') || app.models.gemini[0];
                        [pref, ...app.models.gemini.filter(m=>m!==pref)].forEach(m => attempts.push({p:'gemini', m, k}));
                    }
                    if(app.config.get('key_groq')) app.models.groq.forEach(m => attempts.push({p:'groq', m, k:app.config.get('key_groq')}));
                    if(app.config.get('key_cerebras')) app.models.cerebras.forEach(m => attempts.push({p:'cerebras', m, k:app.config.get('key_cerebras')}));

                    for(const att of attempts) {
                        try {
                            if(att.p !== 'gemini') app.ui.updateBatch(idx, 'fallback');
                            document.getElementById('activeProvider').textContent = `${att.p}: ${att.m}`;
                            const pd = app.providers[att.p];
                            const res = await fetch(pd.url(att.m, att.k), {
                                method: 'POST', headers: pd.headers(att.k), body: JSON.stringify(pd.payload(sysPrompt, text, att.m))
                            });
                            if(!res.ok) throw new Error(res.status);
                            const data = await res.json();
                            const out = pd.extract(data);
                            if(!out) throw new Error("Empty");
                            app.state.results[idx] = out;
                            app.ui.updateBatch(idx, 'success');
                            app.ui.log(`Batch ${idx+1} OK via ${att.m}`, 'success');
                            return;
                        } catch(e) { /* Try next */ }
                    }
                    app.ui.updateBatch(idx, 'error');
                    app.state.results[idx] = "[FAILED]";
                }
            }
        };
        window.addEventListener('DOMContentLoaded', app.ui.init);
    </script>
</body>
</html>